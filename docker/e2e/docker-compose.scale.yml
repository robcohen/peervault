# Scalable E2E testing setup
# Use generate-compose.sh to create docker-compose.generated.yml with N clients
#
# Example: ./generate-compose.sh 5 > docker-compose.generated.yml
#          docker compose -f docker-compose.generated.yml up -d

version: '3.8'

# Base services (relay and minio) - always included
x-base-services:
  relay: &relay
    build:
      context: ./relay
      dockerfile: Dockerfile
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3340/"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - e2e-network

  minio: &minio
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - e2e-network

# Client template - each client is a separate container
x-client: &client-template
  build:
    context: ./client
    dockerfile: Dockerfile
  volumes:
    - ../../dist:/plugin-dist:ro
  shm_size: '2gb'
  security_opt:
    - seccomp:unconfined
  cap_add:
    - SYS_ADMIN
  depends_on:
    relay:
      condition: service_healthy
  networks:
    - e2e-network

networks:
  e2e-network:
    driver: bridge

# This file is a template - use generate-compose.sh to create actual config
services:
  relay:
    <<: *relay
    ports:
      - "3340:3340"

  minio:
    <<: *minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb local/peervault-test --ignore-existing;
      mc anonymous set public local/peervault-test;
      exit 0;
      "
    networks:
      - e2e-network

volumes:
  minio-data:
